(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{326:function(t,v,_){"use strict";_.r(v);var s=_(10),a=Object(s.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h1",{attrs:{id:"protobuf弹幕"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#protobuf弹幕"}},[t._v("#")]),t._v(" protobuf弹幕")]),t._v(" "),v("p",[t._v("2020年5月23日，哔哩哔哩网页端及移动端启用了新的默认弹幕api，网页端弹幕显示的上限变为原弹幕池上限的两倍。")]),t._v(" "),v("p",[t._v("新的api是以6分钟为一个单位加载，即每次加载6分钟内的弹幕")]),t._v(" "),v("ul",[v("li",[v("a",{attrs:{href:"#%E8%8E%B7%E5%8F%96%E5%AE%9E%E6%97%B6%E5%BC%B9%E5%B9%95"}},[t._v("获取实时弹幕")])])]),t._v(" "),v("hr"),t._v(" "),v("h2",{attrs:{id:"获取实时弹幕"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#获取实时弹幕"}},[t._v("#")]),t._v(" 获取实时弹幕")]),t._v(" "),v("blockquote",[v("p",[t._v("https://api.bilibili.com/x/v2/dm/web/seg.so （web端）")]),t._v(" "),v("p",[t._v("https://api.bilibili.com/x/v2/dm/list/seg.so （APP端）")]),t._v(" "),v("p",[t._v("https://i0.hdslb.com/bfs/dm/{data}.bin （BAS/代码弹幕专包）")])]),t._v(" "),v("p",[v("em",[t._v("请求方式：GET")])]),t._v(" "),v("p",[t._v("此接口与漫画弹幕相同")]),t._v(" "),v("p",[t._v("只能返回普通弹幕（"),v("code",[t._v("pool=1")]),t._v(" "),v("code",[t._v("mode=1-7")]),t._v("）和代码弹幕（"),v("code",[t._v("pool=2")]),t._v(" "),v("code",[t._v("mode=8")]),t._v("），BAS弹幕（"),v("code",[t._v("pool=2")]),t._v(" "),v("code",[t._v("mode=9")]),t._v("）请从"),v("RouterLink",{attrs:{to:"/danmaku/danmaku_view_proto.html"}},[t._v("弹幕元数据")]),t._v("中获取")],1),t._v(" "),v("p",[t._v("互动弹幕（UP主头像弹幕、关联视频、内嵌关注按钮）也不存在这个接口，请从"),v("RouterLink",{attrs:{to:"/danmaku/danmaku_view_proto.html"}},[t._v("弹幕元数据")]),t._v("中获取")],1),t._v(" "),v("p",[v("strong",[t._v("注：仅获取6min的整数倍时间内的弹幕，6min内最多弹幕数为6000条（如第一包中弹幕"),v("code",[t._v("progress")]),t._v("值域为0-360000）")])]),t._v(" "),v("p",[v("strong",[t._v("url参数：")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("参数名")]),t._v(" "),v("th",[t._v("类型")]),t._v(" "),v("th",[t._v("内容")]),t._v(" "),v("th",[t._v("必要性")]),t._v(" "),v("th",[t._v("备注")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("type")]),t._v(" "),v("td",[t._v("num")]),t._v(" "),v("td",[t._v("弹幕类")]),t._v(" "),v("td",[t._v("必要")]),t._v(" "),v("td",[t._v("1：视频弹幕")])]),t._v(" "),v("tr",[v("td",[t._v("oid")]),t._v(" "),v("td",[t._v("num")]),t._v(" "),v("td",[t._v("视频cid")]),t._v(" "),v("td",[t._v("必要")]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",[t._v("pid")]),t._v(" "),v("td",[t._v("num")]),t._v(" "),v("td",[t._v("稿件avid")]),t._v(" "),v("td",[t._v("非必要")]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",[t._v("segment_index")]),t._v(" "),v("td",[t._v("num")]),t._v(" "),v("td",[t._v("分包")]),t._v(" "),v("td",[t._v("必要")]),t._v(" "),v("td",[t._v("6分钟一包")])])])]),t._v(" "),v("p",[v("strong",[t._v("proto回复：")])]),t._v(" "),v("p",[t._v("proto定义见："),v("a",{attrs:{href:"../grpc_api/bilibili/community/service/dm/v1/dm.proto"}},[t._v("bilibili.community.service.dm.v1.DmSegMobileReply")])]),t._v(" "),v("ul",[v("li",[v("p",[v("a",{attrs:{href:"https://protogen.marcgravell.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("protogen.marcgravell"),v("OutboundLink")],1),t._v(": 在线编译protogen工具, 无需再安装本地编译器(生成文件需加后缀‘_pb2.py‘才可使用)")])]),t._v(" "),v("li",[v("p",[v("a",{attrs:{href:"https://pypi.org/project/protobuf/",target:"_blank",rel:"noopener noreferrer"}},[t._v("protobuf pip"),v("OutboundLink")],1),t._v(": 可一键安装的python的protogen解析库")])])]),t._v(" "),v("p",[t._v("消息"),v("code",[t._v("DmSegMobileReply")]),t._v("：")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("名称")]),t._v(" "),v("th",[t._v("类型")]),t._v(" "),v("th",[t._v("含义")]),t._v(" "),v("th",[t._v("备注")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("elems")]),t._v(" "),v("td",[t._v("repeated DanmakuElem")]),t._v(" "),v("td",[t._v("弹幕条目")]),t._v(" "),v("td")])])]),t._v(" "),v("p",[t._v("消息"),v("code",[t._v("DanmakuElem")]),t._v("：")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("名称")]),t._v(" "),v("th",[t._v("类型")]),t._v(" "),v("th",[t._v("含义")]),t._v(" "),v("th",[t._v("备注")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("id")]),t._v(" "),v("td",[t._v("int64")]),t._v(" "),v("td",[t._v("弹幕dmid")]),t._v(" "),v("td",[t._v("唯一  可用于操作参数")])]),t._v(" "),v("tr",[v("td",[t._v("progress")]),t._v(" "),v("td",[t._v("int32")]),t._v(" "),v("td",[t._v("视频内弹幕出现时间")]),t._v(" "),v("td",[t._v("毫秒")])]),t._v(" "),v("tr",[v("td",[t._v("mode")]),t._v(" "),v("td",[t._v("int32")]),t._v(" "),v("td",[t._v("弹幕类型")]),t._v(" "),v("td",[t._v("1 2 3：普通弹幕"),v("br"),t._v("4：底部弹幕"),v("br"),t._v("5：顶部弹幕"),v("br"),t._v("6：逆向弹幕"),v("br"),t._v("7：高级弹幕"),v("br"),t._v("8：代码弹幕"),v("br"),t._v("9：BAS弹幕（仅限于特殊弹幕专包）")])]),t._v(" "),v("tr",[v("td",[t._v("fontsize")]),t._v(" "),v("td",[t._v("int32")]),t._v(" "),v("td",[t._v("弹幕字号")]),t._v(" "),v("td",[t._v("18：小"),v("br"),t._v("25：标准"),v("br"),t._v("36：大")])]),t._v(" "),v("tr",[v("td",[t._v("color")]),t._v(" "),v("td",[t._v("uint32")]),t._v(" "),v("td",[t._v("弹幕颜色")]),t._v(" "),v("td",[t._v("十进制RGB888值")])]),t._v(" "),v("tr",[v("td",[t._v("midHash")]),t._v(" "),v("td",[t._v("string")]),t._v(" "),v("td",[t._v("发送者mid的HASH")]),t._v(" "),v("td",[t._v("用于屏蔽用户和查看用户发送的所有弹幕   也可反查用户id")])]),t._v(" "),v("tr",[v("td",[t._v("content")]),t._v(" "),v("td",[t._v("string")]),t._v(" "),v("td",[t._v("弹幕内容")]),t._v(" "),v("td",[t._v("utf-8编码")])]),t._v(" "),v("tr",[v("td",[t._v("ctime")]),t._v(" "),v("td",[t._v("int64")]),t._v(" "),v("td",[t._v("弹幕发送时间")]),t._v(" "),v("td",[t._v("时间戳")])]),t._v(" "),v("tr",[v("td",[t._v("weight")]),t._v(" "),v("td",[t._v("int32")]),t._v(" "),v("td",[t._v("权重")]),t._v(" "),v("td",[t._v("用于智能屏蔽，根据弹幕语义及长度通过AI识别得出"),v("br"),t._v("范围：[0-10]"),v("br"),t._v("值越大权重越高")])]),t._v(" "),v("tr",[v("td",[t._v("action")]),t._v(" "),v("td",[t._v("string")]),t._v(" "),v("td",[t._v("动作？")]),t._v(" "),v("td",[t._v("作用尚不明确")])]),t._v(" "),v("tr",[v("td",[t._v("pool")]),t._v(" "),v("td",[t._v("int32")]),t._v(" "),v("td",[t._v("弹幕池")]),t._v(" "),v("td",[t._v("0：普通池"),v("br"),t._v("1：字幕池"),v("br"),t._v("2：特殊池（代码/BAS弹幕）")])]),t._v(" "),v("tr",[v("td",[t._v("idStr")]),t._v(" "),v("td",[t._v("string")]),t._v(" "),v("td",[t._v("弹幕dmid")]),t._v(" "),v("td",[t._v("字串形式"),v("br"),t._v("唯一  可用于操作参数")])])])]),t._v(" "),v("p",[v("strong",[t._v("示例：")])]),t._v(" "),v("p",[t._v("获取视频"),v("code",[t._v("av810872(cid=1176840)")]),t._v("（炮姐）的实时弹幕分包1")]),t._v(" "),v("p",[v("strong",[t._v("注："),v("a",{attrs:{href:"../grpc_api/bilibili/community/service/dm/v1/dm.proto"}},[t._v("proto定义")]),t._v("需要编译，"),v("code",[t._v("bilibili.community.service.dm.v1.dm_pb2")]),t._v("并非通过pypi安装")])]),t._v(" "),v("div",{staticClass:"language-python extra-class"},[v("pre",{pre:!0,attrs:{class:"language-python"}},[v("code",[v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" requests\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" google"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("protobuf"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text_format "),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" text_format\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" bilibili"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("community"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("service"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dm"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("v1"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dm_pb2 "),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Danmaku\n\nurl "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.bilibili.com/x/v2/dm/web/seg.so'")]),t._v("\nparams "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),v("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("         "),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 弹幕类型")]),t._v("\n    "),v("span",{pre:!0,attrs:{class:"token string"}},[t._v("'oid'")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("1176840")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cid")]),t._v("\n    "),v("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pid'")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("810872")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("     "),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# avid")]),t._v("\n    "),v("span",{pre:!0,attrs:{class:"token string"}},[t._v("'segment_index'")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 弹幕分段")]),t._v("\n"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nresp "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" requests"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" params"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndata "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resp"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content\n\ndanmaku_seg "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Danmaku"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DmSegMobileReply"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndanmaku_seg"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ParseFromString"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text_format"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageToString"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("danmaku_seg"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elems"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" as_utf8"),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),v("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),v("p",[t._v("输出：")]),t._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v('id: 711923911\nprogress: 47880\nmode: 1\nfontsize: 18\ncolor: 10092288\nmidHash: "59417e95"\ncontent: "世界第一电击公主殿下,遇到你是我一生最美好的风景!吾炮赛高,永生不离!唯我超电磁炮永世长存! "\nctime: 1418799826\nweight: 6\nidStr: "711923911"\nattr: 1\n')])])])])}),[],!1,null,null,null);v.default=a.exports}}]);